{% extends 'base.html' %}

{% block title %}Productos{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/inventario.css') }}">
{% endblock %}

{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="box-container">
  <div class="section-header">
    <div>
      <span class="section-title">Productos</span>
    </div>
    <button class="btn btn-main" data-bs-toggle="modal" data-bs-target="#modalNuevoProducto">
      <i class="bi bi-plus-lg"></i> Nuevo Producto
    </button>
  </div>
  <div class="d-flex flex-wrap align-items-center mb-3 gap-2 justify-content-between">
    <input type="text" id="buscadorProductos" class="search-box" placeholder="Buscar producto...">
    <div class="btn-group" role="group">
      <a href="{{ url_for('inventario.inventario_general') }}" class="btn btn-tab">Inventario</a>
      <a href="{{ url_for('producto.productos') }}" class="btn btn-tab active">Productos</a>
    </div>
  </div>
  <div class="mb-3">
    <div class="btn-group" role="group">
      <button class="btn btn-outline-primary btn-sm" onclick="filtrarProductos('todos')">Todos</button>
      <button class="btn btn-outline-success btn-sm" onclick="filtrarProductos('activo')">Activos</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="filtrarProductos('descontinuado')">Descontinuados</button>
    </div>
  </div>
  <div class="table-responsive">
    <table class="table table-inventario align-middle">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Descripción</th>
          <th>Tipo</th>
          <th>Precios<br><small>(1-7 / 8-15 / 16-30 / 31+ días)</small></th>
          <th>Piezas asociadas</th>
          <th>Estatus</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for producto in productos %}
        <tr data-estatus="{{ producto.estatus }}">
          <td>{{ producto.nombre }}</td>
          <td>{{ producto.descripcion }}</td>
          <td>{{ 'Kit' if producto.tipo == 'conjunto' else 'Individual' }}</td>
          <td>
            ${{ producto.precio_7dias }} /
            ${{ producto.precio_15dias }} /
            ${{ producto.precio_30dias }} /
            ${{ producto.precio_31mas }}
          </td>
          <td>
            {% if producto.tipo == 'conjunto' %}
              {% for pieza in producto.piezas %}
                {{ pieza.nombre_pieza }} (x{{ pieza.cantidad }})<br>
              {% endfor %}
            {% else %}
              {{ producto.piezas[0].nombre_pieza }}
            {% endif %}
          </td>
          <td>
            {% if producto.estatus == 'activo' %}
              <span class="badge bg-success">Activo</span>
            {% else %}
              <span class="badge bg-secondary">Descontinuado</span>
            {% endif %}
          </td>
          <td>
            <button class="btn btn-primary btn-sm action-btn" data-bs-toggle="modal"
              data-bs-target="#modalEditarProducto{{ producto.id_producto }}">
              <i class="bi bi-pencil"></i>
            </button>
            {% if producto.estatus == 'activo' %}
              <form method="POST"
                action="{{ url_for('producto.dar_baja_producto', id_producto=producto.id_producto) }}"
                style="display:inline;">
                <button class="btn btn-outline-secondary btn-sm action-btn" title="Descontinuar"
                  onclick="return confirm('¿Descontinuar este producto?');">
                  <i class="bi bi-ban"></i>
                </button>
              </form>
            {% else %}
              <form method="POST"
                action="{{ url_for('producto.dar_alta_producto', id_producto=producto.id_producto) }}"
                style="display:inline;">
                <button class="btn btn-success btn-sm action-btn" title="Activar"
                  onclick="return confirm('¿Activar este producto?');">
                  <i class="bi bi-arrow-up-circle"></i>
                </button>
              </form>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal Editar Producto (fuera del tbody) -->
{% for producto in productos %}
<div class="modal fade" id="modalEditarProducto{{ producto.id_producto }}" tabindex="-1"
  aria-labelledby="modalEditarProductoLabel{{ producto.id_producto }}" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form method="POST" action="{{ url_for('producto.editar_producto', id_producto=producto.id_producto) }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalEditarProductoLabel{{ producto.id_producto }}">
            Editar Producto
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-2">
              <label class="form-label">Nombre</label>
              <input type="text" class="form-control" name="nombre" value="{{ producto.nombre }}" required>
            </div>
            <div class="col-md-6 mb-2">
              <label class="form-label">Tipo</label>
              <input type="text" class="form-control" value="{{ 'Kit' if producto.tipo == 'conjunto' else 'Individual' }}" disabled>
            </div>
          </div>
          <div class="mb-2">
            <label class="form-label">Descripción</label>
            <textarea class="form-control" name="descripcion">{{ producto.descripcion }}</textarea>
          </div>
          <div class="row">
            <div class="col-md-3 mb-2">
              <label class="form-label">Precio 1-7 días</label>
              <input type="number" step="0.01" class="form-control" name="precio_7dias" value="{{ producto.precio_7dias }}" required>
            </div>
            <div class="col-md-3 mb-2">
              <label class="form-label">Precio 8-15 días</label>
              <input type="number" step="0.01" class="form-control" name="precio_15dias" value="{{ producto.precio_15dias }}" required>
            </div>
            <div class="col-md-3 mb-2">
              <label class="form-label">Precio 16-30 días</label>
              <input type="number" step="0.01" class="form-control" name="precio_30dias" value="{{ producto.precio_30dias }}" required>
            </div>
            <div class="col-md-3 mb-2">
              <label class="form-label">Precio 31+ días</label>
              <input type="number" step="0.01" class="form-control" name="precio_31mas" value="{{ producto.precio_31mas }}" required>
            </div>
          </div>
          <hr>
          {% if producto.tipo == 'individual' %}
          <div class="mb-2">
            <label class="form-label">Pieza asociada</label>
            <select class="form-select" name="pieza_individual">
              {% for pieza in piezas %}
                <option value="{{ pieza.id_pieza }}"
                  {% if producto.piezas[0].nombre_pieza == pieza.nombre_pieza %}selected{% endif %}>
                  {{ pieza.nombre_pieza }}
                </option>
              {% endfor %}
            </select>
          </div>
          {% else %}
          <div class="mb-2">
            <label class="form-label">Piezas del kit</label>
            <div id="kitPiezasContainerEditar{{ producto.id_producto }}">
              {% for pieza in producto.piezas %}
              <div class="row mb-2 kit-pieza-row">
                <div class="col-7">
                  <select class="form-select" name="pieza_kit[]">
                    {% for p in piezas %}
                      <option value="{{ p.id_pieza }}"
                        {% if pieza.nombre_pieza == p.nombre_pieza %}selected{% endif %}>
                        {{ p.nombre_pieza }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-3">
                  <input type="number" class="form-control" name="cantidad_kit[]" min="1" value="{{ pieza.cantidad }}" required>
                </div>
                <div class="col-2">
                  <button type="button" class="btn btn-danger btn-sm" onclick="eliminarKitPiezaRowEditar(this)">&times;</button>
                </div>
              </div>
              {% endfor %}
            </div>
            <button type="button" class="btn btn-outline-primary btn-sm"onclick="agregarKitPiezaRowEditar({{producto.id_producto}})"> Agregar pieza</button>
          </div>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar cambios</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endfor %}

<!-- Modal Nuevo Producto -->
<div class="modal fade" id="modalNuevoProducto" tabindex="-1" aria-labelledby="modalNuevoProductoLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form method="POST" action="{{ url_for('producto.crear_producto') }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalNuevoProductoLabel">Nuevo Producto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-2">
              <label class="form-label">Nombre</label>
              <input type="text" class="form-control" name="nombre" required>
            </div>
            <div class="col-md-6 mb-2">
              <label class="form-label">Tipo</label>
              <select class="form-select" name="tipo" id="tipoProducto" required onchange="mostrarSelectorPiezas()">
                <option value="individual">Individual</option>
                <option value="conjunto">Kit (conjunto)</option>
              </select>
            </div>
          </div>
          <div class="mb-2">
            <label class="form-label">Descripción</label>
            <textarea class="form-control" name="descripcion"></textarea>
          </div>
          <div class="row">
            <div class="col-md-3 mb-2">
              <label class="form-label">Precio 1-7 días</label>
              <input type="number" step="0.01" class="form-control" name="precio_7dias" required>
            </div>
            <div class="col-md-3 mb-2">
              <label class="form-label">Precio 8-15 días</label>
              <input type="number" step="0.01" class="form-control" name="precio_15dias" required>
            </div>
            <div class="col-md-3 mb-2">
              <label class="form-label">Precio 16-30 días</label>
              <input type="number" step="0.01" class="form-control" name="precio_30dias" required>
            </div>
            <div class="col-md-3 mb-2">
              <label class="form-label">Precio 31+ días</label>
              <input type="number" step="0.01" class="form-control" name="precio_31mas" required>
            </div>
          </div>
          <hr>
          <div class="mb-2" id="selectorPiezas">
            <div id="piezasIndividual" style="display:block;">
              <label class="form-label">Selecciona la pieza del inventario</label>
              <select class="form-select" name="pieza_individual">
                {% for pieza in piezas %}
                  <option value="{{ pieza.id_pieza }}">{{ pieza.nombre_pieza }}</option>
                {% endfor %}
              </select>
            </div>
            <div id="piezasKit" style="display:none;">
              <label class="form-label">Agrega piezas al kit</label>
              <div id="kitPiezasContainer">
                <div class="row mb-2 kit-pieza-row">
                  <div class="col-8">
                    <select class="form-select" name="pieza_kit[]">
                      {% for pieza in piezas %}
                        <option value="{{ pieza.id_pieza }}">{{ pieza.nombre_pieza }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-3">
                    <input type="number" class="form-control" name="cantidad_kit[]" min="1" value="1" required>
                  </div>
                  <div class="col-1">
                    <button type="button" class="btn btn-danger btn-sm" onclick="eliminarKitPiezaRow(this)">&times;</button>
                  </div>
                </div>
              </div>
              <button type="button" class="btn btn-outline-primary btn-sm" onclick="agregarKitPiezaRow()">Agregar pieza</button>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">Guardar</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/producto.js') }}"></script>
{% endblock %}